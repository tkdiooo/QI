<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!-- 登录 -->
<div class="form">
    <div class="title">
        <h2>Sign In</h2>
    </div>
    <form id="loginForm" method="post" class="form-horizontal" autocomplete="off">
        <!-- 帐号 -->
        <div class="form-group">
            <div class="col-lg-12">
                <input class="form-control" id="account" name="account" placeholder="account" th:value="${account}"/>
            </div>
        </div>
        <div class="form-group">
            <div class="col-lg-12">
                <input class="form-control" type="password" id="password" name="password" placeholder="password"/>
            </div>
        </div>
        <div class="forget">
            <a href="#" target="_blank" class="ext">forget you password?</a>
        </div>
        <div class="options">
            <input class="ipt-c" id="rmbUser" name="remember" type="checkbox" th:checked="${remember}"/>
            <label for="rmbUser">Remember me</label>
            <input type="button" class="login-button" value="SIGN-IN" onclick="login();"/>
        </div>
    </form>
</div>
<div class="widget">
    <div class="warn corner-all">
        <img th:src="${application.static_resource} + '/static/sso/images/warning.png'"/>
        <span id="warning_msg"></span>
    </div>
</div>
<div class="register">
    looking to <a href="#" target="_blank">create an account</a> ?
</div>
<script th:inline="javascript">
    (function ($) {
        $('#loginForm').bootstrapValidator({
            message: 'This value is not valid',
            feedbackIcons: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            fields: {
                account: {
                    validators: {
                        notEmpty: {
                            message: 'The first name is required and cannot be empty'
                        }
                    }
                },
                lastName: {
                    validators: {
                        notEmpty: {
                            message: 'The last name is required and cannot be empty'
                        }
                    }
                },
                username: {
                    message: 'The username is not valid',
                    validators: {
                        notEmpty: {
                            message: 'The username is required and cannot be empty'
                        },
                        stringLength: {
                            min: 6,
                            max: 30,
                            message: 'The username must be more than 6 and less than 30 characters long'
                        },
                        regexp: {
                            regexp: /^[a-zA-Z0-9_\.]+$/,
                            message: 'The username can only consist of alphabetical, number, dot and underscore'
                        },
                        remote: {
                            url: 'remote.php',
                            message: 'The username is not available'
                        },
                        different: {
                            field: 'password',
                            message: 'The username and password cannot be the same as each other'
                        }
                    }
                },
                email: {
                    validators: {
                        emailAddress: {
                            message: 'The input is not a valid email address'
                        }
                    }
                },
                password: {
                    validators: {
                        notEmpty: {
                            message: 'The password is required and cannot be empty'
                        },
                        identical: {
                            field: 'confirmPassword',
                            message: 'The password and its confirm are not the same'
                        },
                        different: {
                            field: 'username',
                            message: 'The password cannot be the same as username'
                        }
                    }
                },
                confirmPassword: {
                    validators: {
                        notEmpty: {
                            message: 'The confirm password is required and cannot be empty'
                        },
                        identical: {
                            field: 'password',
                            message: 'The password and its confirm are not the same'
                        },
                        different: {
                            field: 'username',
                            message: 'The password cannot be the same as username'
                        }
                    }
                },
                birthday: {
                    validators: {
                        date: {
                            format: 'YYYY/MM/DD',
                            message: 'The birthday is not valid'
                        }
                    }
                },
                gender: {
                    validators: {
                        notEmpty: {
                            message: 'The gender is required'
                        }
                    }
                },
                'languages[]': {
                    validators: {
                        notEmpty: {
                            message: 'Please specify at least one language you can speak'
                        }
                    }
                },
                'programs[]': {
                    validators: {
                        choice: {
                            min: 2,
                            max: 4,
                            message: 'Please choose 2 - 4 programming languages you are good at'
                        }
                    }
                },
                captcha: {
                    validators: {
                        callback: {
                            message: 'Wrong answer',
                            callback: function (value, validator) {
                                var items = $('#captchaOperation').html().split(' '),
                                    sum = parseInt(items[0]) + parseInt(items[2]);
                                return value == sum;
                            }
                        }
                    }
                }
            }
        });

        // Validate the form manually
        $('#validateBtn').click(function () {
            $('#defaultForm').bootstrapValidator('validate')
        });

        $('#sdsd').click(function () {
            $('#defaultForm').data('bootstrapValidator').resetForm(true);
        });
    })(jQuery);

    function login() {
        var formValid = $("#loginForm").data('bootstrapValidator');
        formValid.validate();
        if (formValid.isValid()) {
            var formParams = $("#loginForm").serializeJson();
            console.info(formParams)
            var key = getRSAKey();
            var _csrf = $('#_csrf');
            formParams.account = encryptedString(key, formParams.account);
            formParams.password = encryptedString(key, formParams.password);
            formParams[_csrf.attr('name')] = _csrf.val();
            console.info(formParams)
            var opt = {
                handler: function (result) {
                    if (!result.success) {
                        $('#warning_msg').text(result.messages.join('<br/>'));
                        $('.warn').show();
                    } else {
                        layer.closeAll();
                        $('#login').remove();
                        $('.navbar-nav').append('<li class="dropdown">\n' +
                            '                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">' + result.result + '<b class="caret"></b></a>\n' +
                            '                            <ul class="dropdown-menu">\n' +
                            '                                <li><a href="#">账号设置</a></li>\n' +
                            '                                <li><a href="#">退出</a></li>\n' +
                            '                            </ul>\n' +
                            '                        </li>');


                    }
                }
            };
            ajax_action(/*[[@{/login}]]*/ '', formParams, opt);
        }
//        layer.close(layer.index);
    }

    function getRSAKey() {
        setMaxDigits([[${Digits}]]);
        return new RSAKeyPair([[${Exponent}]], "", [[${Modulus}]]);
    }
</script>
</html>